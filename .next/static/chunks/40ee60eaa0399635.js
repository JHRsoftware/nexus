(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,85649,e=>{e.v({actions:"edit-invoice-module__TriEPG__actions",addProductSection:"edit-invoice-module__TriEPG__addProductSection",amountDue:"edit-invoice-module__TriEPG__amountDue",amountPaid:"edit-invoice-module__TriEPG__amountPaid",balanceClear:"edit-invoice-module__TriEPG__balanceClear",balanceDue:"edit-invoice-module__TriEPG__balanceDue",cancelButton:"edit-invoice-module__TriEPG__cancelButton",cancelCreditLimitBtn:"edit-invoice-module__TriEPG__cancelCreditLimitBtn",cashDiscountLabel:"edit-invoice-module__TriEPG__cashDiscountLabel",checkbox:"edit-invoice-module__TriEPG__checkbox",checkboxLabel:"edit-invoice-module__TriEPG__checkboxLabel",clearSelection:"edit-invoice-module__TriEPG__clearSelection",comingSoon:"edit-invoice-module__TriEPG__comingSoon",completed:"edit-invoice-module__TriEPG__completed",container:"edit-invoice-module__TriEPG__container",creditInfoSection:"edit-invoice-module__TriEPG__creditInfoSection",creditLimitActions:"edit-invoice-module__TriEPG__creditLimitActions",creditLimitEdit:"edit-invoice-module__TriEPG__creditLimitEdit",creditLimitInput:"edit-invoice-module__TriEPG__creditLimitInput",creditLimitSection:"edit-invoice-module__TriEPG__creditLimitSection",creditWarning:"edit-invoice-module__TriEPG__creditWarning",dark:"edit-invoice-module__TriEPG__dark",discountInput:"edit-invoice-module__TriEPG__discountInput",dropdown:"edit-invoice-module__TriEPG__dropdown",dropdownItem:"edit-invoice-module__TriEPG__dropdownItem",editCreditLimitBtn:"edit-invoice-module__TriEPG__editCreditLimitBtn",editSection:"edit-invoice-module__TriEPG__editSection",editTitle:"edit-invoice-module__TriEPG__editTitle",error:"edit-invoice-module__TriEPG__error",fadeIn:"edit-invoice-module__TriEPG__fadeIn",field:"edit-invoice-module__TriEPG__field",form:"edit-invoice-module__TriEPG__form",header:"edit-invoice-module__TriEPG__header",input:"edit-invoice-module__TriEPG__input",invoiceDetails:"edit-invoice-module__TriEPG__invoiceDetails",invoiceInfo:"edit-invoice-module__TriEPG__invoiceInfo",invoiceNumber:"edit-invoice-module__TriEPG__invoiceNumber",invoiceShop:"edit-invoice-module__TriEPG__invoiceShop",invoiceTypeNotesRow:"edit-invoice-module__TriEPG__invoiceTypeNotesRow",itemRow:"edit-invoice-module__TriEPG__itemRow",itemRowNoDiscount:"edit-invoice-module__TriEPG__itemRowNoDiscount",itemsHeader:"edit-invoice-module__TriEPG__itemsHeader",itemsHeaderNoDiscount:"edit-invoice-module__TriEPG__itemsHeaderNoDiscount",itemsSection:"edit-invoice-module__TriEPG__itemsSection",itemsTable:"edit-invoice-module__TriEPG__itemsTable",label:"edit-invoice-module__TriEPG__label",loading:"edit-invoice-module__TriEPG__loading",minimumStockNote:"edit-invoice-module__TriEPG__minimumStockNote",netTotal:"edit-invoice-module__TriEPG__netTotal",netTotalDisplay:"edit-invoice-module__TriEPG__netTotalDisplay",noItemsMessage:"edit-invoice-module__TriEPG__noItemsMessage",noItemsRow:"edit-invoice-module__TriEPG__noItemsRow",notesInput:"edit-invoice-module__TriEPG__notesInput",overdueDetails:"edit-invoice-module__TriEPG__overdueDetails",overdueItem:"edit-invoice-module__TriEPG__overdueItem",overdueMore:"edit-invoice-module__TriEPG__overdueMore",overdueWarning:"edit-invoice-module__TriEPG__overdueWarning",partial:"edit-invoice-module__TriEPG__partial",paymentAmount:"edit-invoice-module__TriEPG__paymentAmount",paymentDueDate:"edit-invoice-module__TriEPG__paymentDueDate",paymentInfoCard:"edit-invoice-module__TriEPG__paymentInfoCard",paymentInfoGrid:"edit-invoice-module__TriEPG__paymentInfoGrid",paymentInfoLabel:"edit-invoice-module__TriEPG__paymentInfoLabel",paymentInfoSection:"edit-invoice-module__TriEPG__paymentInfoSection",paymentInfoTitle:"edit-invoice-module__TriEPG__paymentInfoTitle",paymentStatus:"edit-invoice-module__TriEPG__paymentStatus",paymentWarning:"edit-invoice-module__TriEPG__paymentWarning",pending:"edit-invoice-module__TriEPG__pending",permissionNote:"edit-invoice-module__TriEPG__permissionNote",price:"edit-invoice-module__TriEPG__price",priceInput:"edit-invoice-module__TriEPG__priceInput",product:"edit-invoice-module__TriEPG__product",productCode:"edit-invoice-module__TriEPG__productCode",productDetails:"edit-invoice-module__TriEPG__productDetails",productInfo:"edit-invoice-module__TriEPG__productInfo",productName:"edit-invoice-module__TriEPG__productName",productUnavailable:"edit-invoice-module__TriEPG__productUnavailable",profitRow:"edit-invoice-module__TriEPG__profitRow",pulse:"edit-invoice-module__TriEPG__pulse",quantityInput:"edit-invoice-module__TriEPG__quantityInput",removeButton:"edit-invoice-module__TriEPG__removeButton",repContact:"edit-invoice-module__TriEPG__repContact",repName:"edit-invoice-module__TriEPG__repName",row:"edit-invoice-module__TriEPG__row",saveCredtiLimitBtn:"edit-invoice-module__TriEPG__saveCredtiLimitBtn",searchContainer:"edit-invoice-module__TriEPG__searchContainer",searchSection:"edit-invoice-module__TriEPG__searchSection",searchTitle:"edit-invoice-module__TriEPG__searchTitle",sectionTitle:"edit-invoice-module__TriEPG__sectionTitle",select:"edit-invoice-module__TriEPG__select",selectedShopDetails:"edit-invoice-module__TriEPG__selectedShopDetails",shopDetailCard:"edit-invoice-module__TriEPG__shopDetailCard",shopDetailLabel:"edit-invoice-module__TriEPG__shopDetailLabel",shopDetailRow:"edit-invoice-module__TriEPG__shopDetailRow",shopDetailValue:"edit-invoice-module__TriEPG__shopDetailValue",shopInfo:"edit-invoice-module__TriEPG__shopInfo",shopName:"edit-invoice-module__TriEPG__shopName",shopOwner:"edit-invoice-module__TriEPG__shopOwner",slideIn:"edit-invoice-module__TriEPG__slideIn",submitButton:"edit-invoice-module__TriEPG__submitButton",submitSection:"edit-invoice-module__TriEPG__submitSection",success:"edit-invoice-module__TriEPG__success",textarea:"edit-invoice-module__TriEPG__textarea",title:"edit-invoice-module__TriEPG__title",totalDisplay:"edit-invoice-module__TriEPG__totalDisplay",totalPrice:"edit-invoice-module__TriEPG__totalPrice",totalRow:"edit-invoice-module__TriEPG__totalRow",totalsGrid:"edit-invoice-module__TriEPG__totalsGrid",totalsSection:"edit-invoice-module__TriEPG__totalsSection",unauthorized:"edit-invoice-module__TriEPG__unauthorized",unavailableTag:"edit-invoice-module__TriEPG__unavailableTag"})},22096,e=>{"use strict";var t=e.i(43476),i=e.i(71645),a=e.i(18566),l=e.i(11870),s=e.i(57951),n=e.i(89088),o=e.i(85649);let d=()=>{let e=(0,a.useSearchParams)();(0,a.useRouter)();let{isAuthorized:d,isLoading:c}=(0,l.usePageProtection)("invoices-edit"),{user:r,isLoading:u,hasAccess:m}=(0,s.useAuth)(),[h,_]=(0,i.useState)({isSellingPriceReadonly:!1,isDiscountReadonly:!1,showTotalDiscountFromItems:!0,showTotalBalanceDiscount:!1,totalBalanceDiscountPercent:5,hideCostProfit:!1}),p=e=>{let t=new Date(e),i=t.getDate().toString().padStart(2,"0"),a=(t.getMonth()+1).toString().padStart(2,"0"),l=t.getFullYear();return`${i}/${a}/${l}`},v=e=>{let[t,i,a]=e.split("/");return t&&i&&a?`${a}-${i.padStart(2,"0")}-${t.padStart(2,"0")}`:""},[f,N]=(0,i.useState)(new Date().toISOString().split("T")[0]),[g,x]=(0,i.useState)(p(new Date().toISOString().split("T")[0])),[j,y]=(0,i.useState)(null),[T,b]=(0,i.useState)(null),[P,S]=(0,i.useState)(null),[D,E]=(0,i.useState)(!1),[I,w]=(0,i.useState)(0),[L,G]=(0,i.useState)([]),[C,R]=(0,i.useState)(""),[$,A]=(0,i.useState)(""),[k,B]=(0,i.useState)([]),[K,q]=(0,i.useState)(null),[F,O]=(0,i.useState)(""),[M,U]=(0,i.useState)(""),[W,Q]=(0,i.useState)(""),[Y,V]=(0,i.useState)(""),[H,z]=(0,i.useState)(""),[J,X]=(0,i.useState)([]),[Z,ee]=(0,i.useState)([]),[et,ei]=(0,i.useState)([]),[ea,el]=(0,i.useState)([]),[es,en]=(0,i.useState)([]),[eo,ed]=(0,i.useState)(!1),[ec,er]=(0,i.useState)(!1),[eu,em]=(0,i.useState)(!1),[eh,e_]=(0,i.useState)(!1),[ep,ev]=(0,i.useState)(!1),[ef,eN]=(0,i.useState)(""),[eg,ex]=(0,i.useState)(""),[ej,ey]=(0,i.useState)(null),[eT,eb]=(0,i.useState)(null),[eP,eS]=(0,i.useState)(!1),[eD,eE]=(0,i.useState)(!1),[eI,ew]=(0,i.useState)(""),[eL,eG]=(0,i.useState)(!1),[eC,eR]=(0,i.useState)([]),[e$,eA]=(0,i.useState)(!1),ek=()=>{let e=localStorage.getItem("currentUser")||sessionStorage.getItem("currentUser"),t={"Content-Type":"application/json"};return e&&(t["x-user-data"]=e),t},eB=()=>!!(P&&P.discountName.toLowerCase().includes("credit")),eK=e=>{if(!e||10!==e.length)return!1;let[t,i,a]=e.split("/");if(!t||!i||!a)return!1;let l=parseInt(t),s=parseInt(i),n=parseInt(a);if(l<1||l>31||s<1||s>12||n<1900||n>2100)return!1;let o=new Date(n,s-1,l);return o.getFullYear()===n&&o.getMonth()===s-1&&o.getDate()===l},eq=async()=>{try{let e=await fetch("/api/softwareSettings",{headers:ek()});if(e.ok){let t=await e.json();if(t.success&&t.settings&&t.settings.dueDateOptions){B(t.settings.dueDateOptions);let e=t.settings.dueDateOptions.find(e=>e.isDefault);e&&q(e)}}}catch(e){}},eF=async()=>{try{let e=await fetch("/api/discounts"),t=await e.json();t.success&&ei(t.discounts.filter(e=>e.percentage>0))}catch(e){}},eO=(0,i.useCallback)(async e=>{if(e.length<2)return void X([]);try{let t=await fetch(`/api/invoices/search?search=${encodeURIComponent(e)}&limit=10`,{headers:ek()}),i=await t.json();i.success&&X(i.invoices||[])}catch(e){}},[]),eM=(0,i.useCallback)(async e=>{if(e.length<2)return void ee([]);try{let t=await fetch(`/api/shops?search=${encodeURIComponent(e)}&limit=10&activeOnly=true`),i=await t.json();i.success&&ee(i.shops||[])}catch(e){}},[]),eU=(0,i.useCallback)(async e=>{if(e.length<2)return void el([]);try{let t=await fetch(`/api/products/search?search=${encodeURIComponent(e)}&limit=10`),i=await t.json();i.success&&el(i.products||[])}catch(e){}},[]),eW=(0,i.useCallback)(async e=>{try{let t=await fetch(`/api/sales-rep?search=${encodeURIComponent(e)}&activeOnly=true`),i=await t.json();if(i.success){let e=i.salesReps?.filter(e=>"active"===e.status)||[];en(e)}}catch(e){}},[]);(0,i.useEffect)(()=>{let e=setTimeout(()=>{M&&eO(M)},300);return()=>clearTimeout(e)},[M,eO]),(0,i.useEffect)(()=>{let e=setTimeout(()=>{W&&eM(W)},300);return()=>clearTimeout(e)},[W,eM]),(0,i.useEffect)(()=>{let e=setTimeout(()=>{Y&&eU(Y)},300);return()=>clearTimeout(e)},[Y,eU]),(0,i.useEffect)(()=>{let e=setTimeout(()=>{H&&eW(H)},300);return()=>clearTimeout(e)},[H,eW]),(0,i.useEffect)(()=>{let t=e.get("invoiceId");t&&!isNaN(parseInt(t))&&e1(parseInt(t))},[e]),(0,i.useEffect)(()=>{eq(),eF()},[]),(0,i.useEffect)(()=>{if(eB()&&f&&K){let e=new Date(f);e.setDate(e.getDate()+K.days);let t=e.toISOString().split("T")[0];R(t),A(p(t))}else R(""),A("")},[f,P,K]);let eQ=(e,t,i)=>{G(a=>a.map(a=>{if(a.id===e){let e=Number(i);if("quantity"===t){let t=a.availableQty-1;e<=0?(e=1,eN(`Quantity must be at least 1 for ${a.productName}`)):e>t?(eN(`Cannot save invoice! Quantity ${e} exceeds available for sale (${t}) for ${a.productName}. Must maintain minimum stock of 1. Maximum allowed: ${t}`),e=Math.max(1,t)):eN("")}let l={...a,[t]:e};return l.price=Number(l.quantity)*Number(l.sellingPrice),l.totalPrice=l.price-Number(l.discount),l}return a}))},eY=I>0?I:h.totalBalanceDiscountPercent,eV=i.default.useMemo(()=>{let e=L.reduce((e,t)=>e+Number(t.totalPrice),0),t=L.reduce((e,t)=>e+Number(t.discount),0),i=P?Number(e)*(parseFloat(P.percentage.toString())/100):0,a=I>0?I:h.totalBalanceDiscountPercent,l=D?Number(e)*(a/100):0,s=Number(e)-Number(i)-Number(l),n=0,o=0;return L.forEach(e=>{let t=(e.costPrice||0)*e.quantity;n+=t;let i=Number(e.totalPrice),l=P?i*(parseFloat(P.percentage.toString())/100):0,s=D?a/100*i:0;o+=i-l-s-t}),{subTotal:Number(e),totalDiscount:Number(t),invoiceTypeDiscount:Number(i),cashDiscount:Number(l),netTotal:Number(s),totalCost:Number(n),totalProfit:Number(o)}},[L,D,I,h.totalBalanceDiscountPercent,P]),eH=async e=>{if(e.preventDefault(),!j)return void eN("Please select a shop");if(!T)return void eN("Please select a sales representative");if(0===L.length)return void eN("Please add at least one product");if(eB()&&e$){let e=eC.reduce((e,t)=>e+Number(t.remainingAmount),0);eN(`âŒ Cannot update credit invoice! This shop has ${eC.length} overdue payment(s) totaling LKR ${e.toLocaleString()}. Please settle all overdue payments before updating credit invoices.`);return}let t=[];for(let e of L)e.quantity>e.availableQty&&t.push(`${e.productName}: Requested ${e.quantity}, Available ${e.availableQty}`),e.quantity<=0&&t.push(`${e.productName}: Invalid quantity ${e.quantity}`);if(t.length>0)return void eN(`Cannot update invoice! Stock validation failed:
${t.join("\n")}
Please adjust quantities before saving.`);if(eB()&&!eZ()){let e=(j.creditLimit||0)-(j.balanceAmount||0);eN(`Credit limit exceeded! Available credit: LKR ${e.toLocaleString()}. Invoice total: LKR ${eV.netTotal.toLocaleString()}`);return}ev(!0),eN(""),ex("");try{let e={id:ej?.id,invoiceDate:f,shopId:j.id,salesRepId:T.id,discountId:P?.id||null,invoiceType:P?.discountName||null,invoiceTypePercentage:P?.percentage||null,cashDiscountEnabled:D,...P&&P.discountName.toLowerCase().includes("credit")&&C&&{dueDate:C},notes:F||null,items:L.map(e=>({productId:e.productId,quantity:e.quantity,sellingPrice:e.sellingPrice,discount:e.discount}))},t=await fetch("/api/invoices",{method:"PUT",headers:ek(),body:JSON.stringify(e)}),i=await t.json();i.success?(eT&&eT.netTotal!==eV.netTotal&&await eJ(eT.id,eV.netTotal),ex("Invoice updated successfully!"),await e1(ej.id)):eN(i.error||"Failed to update invoice")}catch(e){eN("Network error. Please try again.")}finally{ev(!1)}},ez=async e=>{eS(!0);try{let t=await fetch(`/api/payments?invoiceId=${e}`,{headers:ek()}),i=await t.json();i.success&&i.payments&&i.payments.length>0?eb(i.payments[0]):eb(null)}catch(e){eb(null)}finally{eS(!1)}},eJ=async(e,t)=>{try{let i=await fetch("/api/payments/update-total",{method:"PUT",headers:ek(),body:JSON.stringify({id:e,newNetTotal:t})});(await i.json()).success}catch(e){}},eX=async()=>{if(!j||!eI)return;let e=parseFloat(eI);if(e<0)return void eN("Credit limit cannot be negative");eG(!0),eN("");try{let t=await fetch("/api/shops/update-credit-limit",{method:"PUT",headers:ek(),body:JSON.stringify({shopId:j.id,creditLimit:e})}),i=await t.json();i.success?(y(t=>t?{...t,creditLimit:e}:null),ex(`Credit limit updated successfully to LKR ${e.toLocaleString()}`),eE(!1),ew("")):eN(i.error||"Failed to update credit limit")}catch(e){eN("Network error. Please try again.")}finally{eG(!1)}},eZ=()=>{if(!j||!eB())return!0;let e=(j.creditLimit||0)-(j.balanceAmount||0);return eV.netTotal<=e},e0=async e=>{try{let t=await fetch(`/api/payments?shopId=${e}&status=due`),i=await t.json();if(i.success&&i.payments){let e=i.payments.map(e=>{let t=new Date(e.dueDate),i=new Date,a=Math.floor((i.getTime()-t.getTime())/864e5);return{id:e.id,invoiceNumber:e.invoice.invoiceNumber,dueDate:e.dueDate,remainingAmount:e.remainingAmount,daysPastDue:a}}).filter(e=>e.daysPastDue>0);if(eR(e),eA(e.length>0),e.length>0){let t=e.reduce((e,t)=>e+Number(t.remainingAmount),0);ex(`âš ï¸ This shop has ${e.length} overdue payment(s) totaling LKR ${t.toLocaleString()}. Creating new credit invoices may be restricted.`)}}else eR([]),eA(!1)}catch(e){}},e1=async e=>{ev(!0),eN(""),ex("");try{let t=await fetch(`/api/invoices/${e}`,{headers:ek()}),i=await t.json();if(i.success&&i.invoice){let t=i.invoice;if(N(t.invoiceDate),x(p(t.invoiceDate)),y(t.shop),b(t.salesRep||null),S(t.discount||null),O(t.notes||""),t.shop&&t.shop.id&&await e0(t.shop.id),E(t.cashDiscountEnabled||!1),w(t.cashDiscountPercentage||0),G(t.invoiceItems||[]),t.dueDate){let e=new Date(t.dueDate).toISOString().split("T")[0];R(e)}else R("");ey(t),await ez(e),ex(`Invoice ${t.invoiceNumber} loaded successfully!`)}else eN(i.error||"Failed to load invoice details")}catch(e){eN("Network error. Please try again.")}finally{ev(!1)}};return((0,i.useEffect)(()=>{let e=async()=>{try{if(r){let e=await fetch("/api/softwareSettings",{headers:ek()}),t=await e.json();if(t.success&&t.settings){let e={isSellingPriceReadonly:1===t.settings.isSellingPriceReadonly||!0===t.settings.isSellingPriceReadonly,isDiscountReadonly:1===t.settings.isDiscountReadonly||!0===t.settings.isDiscountReadonly,showTotalDiscountFromItems:1!==t.settings.showTotalDiscountFromItems&&!0!==t.settings.showTotalDiscountFromItems,showTotalBalanceDiscount:1!==t.settings.showTotalBalanceDiscount&&!0!==t.settings.showTotalBalanceDiscount,totalBalanceDiscountPercent:t.settings.totalBalanceDiscountPercent||5,hideCostProfit:1===t.settings.hideCostProfit||!0===t.settings.hideCostProfit};_(e)}}}catch(e){}};!c&&d&&e()},[r,c,d]),c||u)?(0,t.jsx)("div",{className:o.default.loading,children:"Loading..."}):d?(0,t.jsxs)("div",{className:o.default.container,children:[(0,t.jsx)("div",{className:o.default.header,children:(0,t.jsx)("h1",{className:o.default.title,children:"Edit Invoice"})}),(0,t.jsxs)("div",{className:o.default.searchSection,children:[(0,t.jsx)("h2",{className:o.default.searchTitle,children:"Search Invoice to Edit"}),(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Search by Invoice Number or Shop Name:"}),(0,t.jsxs)("div",{className:o.default.searchContainer,children:[(0,t.jsx)("input",{type:"text",value:M,onChange:e=>{U(e.target.value),ed(!0)},onFocus:()=>ed(!0),placeholder:"Type invoice number or shop name...",className:o.default.input,disabled:ep}),eo&&J.length>0&&(0,t.jsx)("div",{className:o.default.dropdown,children:J.map(e=>(0,t.jsx)("div",{className:o.default.dropdownItem,onClick:()=>{e1(e.id),U(`${e.invoiceNumber} - ${e.shopName}`),ed(!1)},children:(0,t.jsxs)("div",{className:o.default.invoiceInfo,children:[(0,t.jsxs)("div",{className:o.default.invoiceNumber,children:["#",e.invoiceNumber]}),(0,t.jsxs)("div",{className:o.default.invoiceShop,children:[e.shopName," (",e.ownerName,")"]}),(0,t.jsxs)("div",{className:o.default.invoiceDetails,children:["Date: ",new Date(e.invoiceDate).toLocaleDateString()," | Total: LKR ",e.netTotal.toLocaleString()]})]})},e.id))})]})]})]}),ef&&(0,t.jsx)("p",{className:o.default.error,children:ef}),eg&&(0,t.jsx)("p",{className:o.default.success,children:eg}),ej&&eT&&(0,t.jsxs)("div",{className:o.default.paymentInfoSection,children:[(0,t.jsx)("h2",{className:o.default.paymentInfoTitle,children:"ðŸ“‹ Pending Payment Information"}),(0,t.jsxs)("div",{className:o.default.paymentInfoGrid,children:[(0,t.jsxs)("div",{className:o.default.paymentInfoCard,children:[(0,t.jsx)("div",{className:o.default.paymentInfoLabel,children:"Payment Status:"}),(0,t.jsx)("div",{className:`${o.default.paymentStatus} ${o.default[eT.paymentStatus]}`,children:eT.paymentStatus.toUpperCase()})]}),(0,t.jsxs)("div",{className:o.default.paymentInfoCard,children:[(0,t.jsx)("div",{className:o.default.paymentInfoLabel,children:"Net Total:"}),(0,t.jsxs)("div",{className:o.default.paymentAmount,children:["LKR ",eT.netTotal.toLocaleString()]})]}),(0,t.jsxs)("div",{className:o.default.paymentInfoCard,children:[(0,t.jsx)("div",{className:o.default.paymentInfoLabel,children:"Paid Amount:"}),(0,t.jsxs)("div",{className:o.default.paymentAmount,children:["LKR ",eT.paidAmount.toLocaleString()]})]}),(0,t.jsxs)("div",{className:o.default.paymentInfoCard,children:[(0,t.jsx)("div",{className:o.default.paymentInfoLabel,children:"Remaining Amount:"}),(0,t.jsxs)("div",{className:`${o.default.paymentAmount} ${eT.remainingAmount>0?o.default.amountDue:o.default.amountPaid}`,children:["LKR ",eT.remainingAmount.toLocaleString()]})]}),eT.dueDate&&(0,t.jsxs)("div",{className:o.default.paymentInfoCard,children:[(0,t.jsx)("div",{className:o.default.paymentInfoLabel,children:"Due Date:"}),(0,t.jsx)("div",{className:o.default.paymentDueDate,children:new Date(eT.dueDate).toLocaleDateString()})]})]}),(0,t.jsxs)("div",{className:o.default.paymentWarning,children:[(0,t.jsx)("strong",{children:"âš ï¸ Note:"})," Editing this invoice will automatically update the pending payment data. If you change the invoice total, the remaining payment amount will be recalculated."]})]}),ej&&(0,t.jsxs)("div",{className:o.default.editSection,children:[(0,t.jsxs)("h2",{className:o.default.editTitle,children:["Editing Invoice #",ej.invoiceNumber]}),(0,t.jsxs)("form",{onSubmit:eH,className:o.default.form,children:[(0,t.jsxs)("div",{className:o.default.row,children:[(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Invoice Date: *"}),(0,t.jsx)("input",{type:"text",placeholder:"DD/MM/YYYY",value:g,onChange:e=>{let t=e.target.value;x(t);let i=t.replace(/[^\d]/g,"");if(i.length>=3&&i.length<=4?i=i.replace(/(\d{2})(\d{1,2})/,"$1/$2"):i.length>=5&&(i=i.replace(/(\d{2})(\d{2})(\d{4})/,"$1/$2/$3")),i!==t&&i.length<=10&&x(i),eK(i)){let e=v(i);e&&N(e)}},onBlur:e=>{if(!eK(e.target.value)){let e=new Date().toISOString().split("T")[0];N(e),x(p(e))}},className:o.default.input,disabled:ep,required:!0,maxLength:10})]}),(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Select Sales Rep: *"}),(0,t.jsxs)("div",{className:o.default.searchContainer,children:[(0,t.jsx)("input",{type:"text",value:T?`${T.name} (${T.contactNumber})`:H,onChange:e=>{T||(z(e.target.value),e_(!0))},onFocus:()=>e_(!0),placeholder:"Type to search sales representatives...",className:o.default.input,disabled:ep,required:!0}),T&&(0,t.jsx)("button",{type:"button",onClick:()=>{b(null),z(""),e_(!1)},className:o.default.clearSelection,disabled:ep,children:"Ã—"}),eh&&es.length>0&&(0,t.jsx)("div",{className:o.default.dropdown,children:es.map(e=>(0,t.jsxs)("div",{className:o.default.dropdownItem,onClick:()=>{b(e),z(""),e_(!1)},children:[(0,t.jsx)("div",{className:o.default.repName,children:e.name}),(0,t.jsx)("div",{className:o.default.repContact,children:e.contactNumber})]},e.id))})]})]}),(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Select Shop: *"}),(0,t.jsxs)("div",{className:o.default.searchContainer,children:[(0,t.jsx)("input",{type:"text",value:j?`${j.shopName} (${j.ownerName})`:W,onChange:e=>{if(!j){let t=e.target.value;Q(t),er(t.length>0)}},onFocus:()=>er(!0),onBlur:()=>{setTimeout(()=>er(!1),150)},placeholder:"Type to search shops...",className:o.default.input,disabled:ep,required:!0}),j&&(0,t.jsx)("button",{type:"button",onClick:()=>{y(null),Q(""),er(!1)},className:o.default.clearSelection,children:"Ã—"}),ec&&Z.length>0&&!j&&(0,t.jsx)("div",{className:o.default.dropdown,children:Z.map(e=>(0,t.jsx)("div",{className:o.default.dropdownItem,onClick:()=>{y(e),Q(""),er(!1)},children:(0,t.jsxs)("div",{className:o.default.shopInfo,children:[(0,t.jsx)("div",{className:o.default.shopName,children:e.shopName}),(0,t.jsxs)("div",{className:o.default.shopOwner,children:["Owner: ",e.ownerName," | Contact: ",e.contactNumber]}),(0,t.jsxs)("div",{className:o.default.shopOwner,children:["Credit Limit: LKR ",e.creditLimit.toLocaleString()," | Balance: LKR ",e.balanceAmount.toLocaleString()]})]})},e.id))})]})]}),j&&(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Selected Shop Details:"}),(0,t.jsx)("div",{className:o.default.selectedShopDetails,children:(0,t.jsxs)("div",{className:o.default.shopDetailCard,children:[(0,t.jsxs)("div",{className:o.default.shopDetailRow,children:[(0,t.jsx)("span",{className:o.default.shopDetailLabel,children:"Shop Name:"}),(0,t.jsx)("span",{className:o.default.shopDetailValue,children:j.shopName})]}),(0,t.jsxs)("div",{className:o.default.shopDetailRow,children:[(0,t.jsx)("span",{className:o.default.shopDetailLabel,children:"Owner:"}),(0,t.jsx)("span",{className:o.default.shopDetailValue,children:j.ownerName})]}),(0,t.jsxs)("div",{className:o.default.shopDetailRow,children:[(0,t.jsx)("span",{className:o.default.shopDetailLabel,children:"Contact:"}),(0,t.jsx)("span",{className:o.default.shopDetailValue,children:j.contactNumber})]}),(0,t.jsxs)("div",{className:o.default.shopDetailRow,children:[(0,t.jsx)("span",{className:o.default.shopDetailLabel,children:"Credit Limit:"}),(0,t.jsx)("div",{className:o.default.creditLimitSection,children:eD?(0,t.jsxs)("div",{className:o.default.creditLimitEdit,children:[(0,t.jsx)("input",{type:"number",value:eI,onChange:e=>ew(e.target.value),placeholder:"Enter new credit limit",className:o.default.creditLimitInput,disabled:eL,min:"0",step:"0.01"}),(0,t.jsxs)("div",{className:o.default.creditLimitActions,children:[(0,t.jsx)("button",{type:"button",onClick:eX,className:o.default.saveCredtiLimitBtn,disabled:eL,children:eL?"Saving...":"ðŸ’¾ Save"}),(0,t.jsx)("button",{type:"button",onClick:()=>{eE(!1),ew(""),eN("")},className:o.default.cancelCreditLimitBtn,disabled:eL,children:"âŒ Cancel"})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("span",{className:o.default.shopDetailValue,children:["LKR ",j.creditLimit.toLocaleString()]}),m("shops")&&(0,t.jsx)("button",{type:"button",onClick:()=>{m("shops")?j&&(ew(j.creditLimit.toString()),eE(!0)):eN("You do not have permission to edit credit limits")},className:o.default.editCreditLimitBtn,disabled:ep,children:"âœï¸ Edit"}),!m("shops")&&(0,t.jsx)("span",{className:o.default.permissionNote,children:"(Edit requires Shop permissions)"})]})})]}),(0,t.jsxs)("div",{className:o.default.shopDetailRow,children:[(0,t.jsx)("span",{className:o.default.shopDetailLabel,children:"Balance:"}),(0,t.jsxs)("span",{className:`${o.default.shopDetailValue} ${j.balanceAmount>0?o.default.balanceDue:o.default.balanceClear}`,children:["LKR ",j.balanceAmount.toLocaleString()]})]}),eB()&&(0,t.jsxs)("div",{className:o.default.creditInfoSection,children:[(0,t.jsxs)("div",{className:o.default.shopDetailRow,children:[(0,t.jsx)("span",{className:o.default.shopDetailLabel,children:"Available Credit:"}),(0,t.jsxs)("span",{className:`${o.default.shopDetailValue} ${(j.creditLimit||0)-(j.balanceAmount||0)<=0?o.default.balanceDue:o.default.balanceClear}`,children:["LKR ",((j.creditLimit||0)-(j.balanceAmount||0)).toLocaleString()]})]}),!eZ()&&(0,t.jsxs)("div",{className:o.default.creditWarning,children:[(0,t.jsx)("strong",{children:"âš ï¸ Credit Limit Warning:"})," Invoice total (LKR ",eV.netTotal.toLocaleString(),") exceeds available credit (LKR ",((j.creditLimit||0)-(j.balanceAmount||0)).toLocaleString(),"). Update cannot proceed."]}),e$&&(0,t.jsxs)("div",{className:o.default.overdueWarning,children:[(0,t.jsx)("strong",{children:"ðŸš¨ Overdue Payments Alert:"})," This shop has ",eC.length," overdue payment(s) totaling LKR ",eC.reduce((e,t)=>e+Number(t.remainingAmount),0).toLocaleString(),". Credit invoice updates are restricted.",(0,t.jsxs)("div",{className:o.default.overdueDetails,children:[eC.slice(0,3).map((e,i)=>(0,t.jsxs)("div",{className:o.default.overdueItem,children:["#",e.invoiceNumber,": LKR ",e.remainingAmount.toLocaleString(),"(",e.daysPastDue," days overdue)"]},e.id)),eC.length>3&&(0,t.jsxs)("div",{className:o.default.overdueMore,children:["... and ",eC.length-3," more"]})]})]})]})]})})]}),(0,t.jsxs)("div",{className:o.default.invoiceTypeNotesRow,children:[(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Invoice Type: *"}),(0,t.jsxs)("select",{value:P?.id||"",onChange:e=>{let t=e.target.value;S(et.find(e=>e.id.toString()===t)||null)},className:o.default.input,disabled:ep,required:!0,children:[(0,t.jsx)("option",{value:"",disabled:!0,children:"Select Invoice Type"}),et.map(e=>(0,t.jsxs)("option",{value:e.id,children:[e.discountName," Discount (",e.percentage,"%)"]},e.id))]})]}),(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Notes:"}),(0,t.jsx)("textarea",{value:F,onChange:e=>O(e.target.value),placeholder:"Enter any additional notes for this invoice...",className:o.default.notesInput,disabled:ep,rows:1})]}),eB()&&(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Payment Terms:"}),(0,t.jsxs)("select",{value:K?`${K.label}-${K.days}`:"",onChange:e=>{let[t,i]=e.target.value.split("-"),a=parseInt(i),l=k.find(e=>e.label===t&&e.days===a);l&&q(l)},className:o.default.select,disabled:ep,children:[(0,t.jsx)("option",{value:"",children:"Select Payment Terms"}),k.map((e,i)=>(0,t.jsxs)("option",{value:`${e.label}-${e.days}`,children:[e.label," (",e.days," days) ",e.isDefault?"- Default":""]},i))]})]})]})]}),eB()&&C&&(0,t.jsx)("div",{className:o.default.row,children:(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Payment Due Date:"}),(0,t.jsx)("input",{type:"text",placeholder:"DD/MM/YYYY",value:$,onChange:e=>{let t=e.target.value;A(t);let i=t.replace(/[^\d]/g,"");i.length>=3&&i.length<=4?i=i.replace(/(\d{2})(\d{1,2})/,"$1/$2"):i.length>=5&&(i=i.replace(/(\d{2})(\d{2})(\d{4})/,"$1/$2/$3")),i!==t&&i.length<=10&&A(i);let a=v(i);a&&R(a)},className:o.default.input,disabled:ep})]})}),(0,t.jsxs)("div",{className:o.default.itemsSection,children:[(0,t.jsx)("h3",{className:o.default.sectionTitle,children:"Invoice Items"}),(0,t.jsx)("div",{className:o.default.addProductSection,children:(0,t.jsxs)("div",{className:o.default.field,children:[(0,t.jsx)("label",{className:o.default.label,children:"Add Product:"}),(0,t.jsxs)("div",{className:o.default.searchContainer,children:[(0,t.jsx)("input",{type:"text",value:Y,onChange:e=>{let t=e.target.value;V(t),em(t.length>0)},onFocus:()=>em(!0),onBlur:()=>{setTimeout(()=>em(!1),150)},placeholder:"Type to search products...",className:o.default.input,disabled:ep}),eu&&ea.length>0&&(0,t.jsx)("div",{className:o.default.dropdown,children:ea.map(e=>{let i=Math.max(0,e.availableQty-1),a=i>0;return(0,t.jsx)("div",{className:`${o.default.dropdownItem} ${!a?o.default.productUnavailable:""}`,onClick:()=>a?(e=>{let t=L.find(t=>t.productId===e.id);if(t){let i=t.availableQty-1;t.quantity<i?eQ(t.id,"quantity",t.quantity+1):eN(`Cannot add more ${e.itemName}. Must maintain minimum stock of 1. Available for sale: ${i}`)}else{if(e.availableQty-1<1){eN(`Cannot add ${e.itemName}. Must maintain minimum stock of 1. Current stock: ${e.availableQty}`),V(""),el([]),em(!1);return}let t={id:`item_${Date.now()}`,productId:e.id,productCode:e.productCode,productName:e.itemName,quantity:1,sellingPrice:e.sellingPrice,discount:0,price:e.sellingPrice,totalPrice:e.sellingPrice,availableQty:e.availableQty,costPrice:e.costPrice||0};G(e=>[...e,t])}V(""),el([]),em(!1)})(e):null,style:{cursor:a?"pointer":"not-allowed"},children:(0,t.jsxs)("div",{className:o.default.productInfo,children:[(0,t.jsxs)("div",{className:o.default.productName,children:[e.itemName," (",e.productCode,")",!a&&(0,t.jsx)("span",{className:o.default.unavailableTag,children:" - UNAVAILABLE"})]}),(0,t.jsxs)("div",{className:o.default.productDetails,children:["Price: LKR ",e.sellingPrice," | Available for Sale: ",i," | Total Stock: ",e.availableQty," | Category: ",e.category,!a&&(0,t.jsxs)("div",{className:o.default.minimumStockNote,children:["(Must maintain minimum stock of ",1,")"]})]})]})},e.id)})})]})]})}),(0,t.jsxs)("div",{className:o.default.itemsTable,children:[(0,t.jsxs)("div",{className:`${o.default.itemsHeader} ${!h.showTotalDiscountFromItems?o.default.itemsHeaderNoDiscount:""}`,children:[(0,t.jsx)("div",{children:"Product"}),(0,t.jsx)("div",{children:"Quantity"}),(0,t.jsx)("div",{children:"Selling Price"}),h.showTotalDiscountFromItems&&(0,t.jsx)("div",{children:"Discount"}),(0,t.jsx)("div",{children:"Price"}),!h.hideCostProfit&&(0,t.jsx)("div",{children:"Cost"}),!h.hideCostProfit&&(0,t.jsx)("div",{children:"Profit"}),(0,t.jsx)("div",{children:"Total Price"}),(0,t.jsx)("div",{children:"Action"})]}),0===L.length?(0,t.jsx)("div",{className:o.default.noItemsRow,children:(0,t.jsx)("div",{className:o.default.noItemsMessage,children:"No items added yet. Search and add products above."})}):L.map(e=>{let i,a;return(0,t.jsxs)("div",{className:`${o.default.itemRow} ${!h.showTotalDiscountFromItems?o.default.itemRowNoDiscount:""}`,children:[(0,t.jsxs)("div",{className:o.default.product,children:[(0,t.jsx)("div",{className:o.default.productName,children:e.productName}),(0,t.jsxs)("div",{className:o.default.productCode,children:["(",e.productCode,")"]})]}),(0,t.jsx)("div",{className:o.default.quantity,children:(0,t.jsx)("input",{type:"number",min:"1",max:Math.max(1,e.availableQty-1),value:e.quantity,onWheel:n.handleNumberInputWheel,onChange:t=>eQ(e.id,"quantity",parseInt(t.target.value)||1),className:o.default.quantityInput})}),(0,t.jsx)("div",{className:o.default.sellingPrice,children:(0,t.jsx)("input",{type:"number",min:"0",step:"0.01",value:e.sellingPrice,onChange:t=>eQ(e.id,"sellingPrice",parseFloat(t.target.value)||0),onWheel:n.handleNumberInputWheel,className:o.default.priceInput,readOnly:h.isSellingPriceReadonly,title:h.isSellingPriceReadonly?"Selling price is read-only (configured in settings)":""})}),h.showTotalDiscountFromItems&&(0,t.jsx)("div",{className:o.default.discount,children:(0,t.jsx)("input",{type:"number",min:"0",step:"0.01",value:e.discount,onChange:t=>eQ(e.id,"discount",parseFloat(t.target.value)||0),onWheel:n.handleNumberInputWheel,className:o.default.discountInput,placeholder:"0.00",readOnly:h.isDiscountReadonly,title:h.isDiscountReadonly?"Discount is read-only (configured in settings)":""})}),(0,t.jsxs)("div",{className:o.default.price,children:["LKR ",e.price.toLocaleString()]}),!h.hideCostProfit&&(0,t.jsxs)("div",{className:o.default.cost,children:["LKR ",(e.costPrice*e.quantity).toLocaleString()]}),!h.hideCostProfit&&(0,t.jsxs)("div",{className:o.default.profit,children:["LKR ",(i=P?e.totalPrice*(parseFloat(P.percentage.toString())/100):0,a=D?e.totalPrice*(eY/100):0,(e.totalPrice-i-a-e.costPrice*e.quantity).toLocaleString())]}),(0,t.jsxs)("div",{className:o.default.totalPrice,children:["LKR ",e.totalPrice.toLocaleString()]}),(0,t.jsx)("div",{className:o.default.actions,children:(0,t.jsx)("button",{type:"button",onClick:()=>{var t;return t=e.id,void G(e=>e.filter(e=>e.id!==t))},className:o.default.removeButton,disabled:ep,children:"ðŸ—‘ï¸"})})]},e.id)})]})]}),(0,t.jsx)("div",{className:o.default.totalsSection,children:(0,t.jsxs)("div",{className:o.default.totalsGrid,children:[(0,t.jsxs)("div",{className:o.default.totalRow,children:[(0,t.jsxs)("span",{children:["Sub Total",P?` - ${P.discountName} Discount (${P.percentage}%)`:"",":"]}),(0,t.jsxs)("span",{children:["LKR ",eV.subTotal.toLocaleString()]})]}),P&&(0,t.jsxs)("div",{className:o.default.totalRow,children:[(0,t.jsxs)("span",{children:["Discount Amount (",P.percentage,"%):"]}),(0,t.jsxs)("span",{children:["- LKR ",eV.invoiceTypeDiscount.toLocaleString()]})]}),h.showTotalDiscountFromItems&&(0,t.jsxs)("div",{className:o.default.totalRow,children:[(0,t.jsx)("span",{children:"Total Discount from Items:"}),(0,t.jsxs)("span",{children:["LKR ",eV.totalDiscount.toLocaleString()]})]}),h.showTotalBalanceDiscount&&(0,t.jsxs)("div",{className:o.default.totalRow,children:[(0,t.jsxs)("label",{className:o.default.cashDiscountLabel,children:[(0,t.jsx)("input",{type:"checkbox",checked:D,onChange:e=>E(e.target.checked),className:o.default.checkbox}),(0,t.jsxs)("span",{children:["Cash Discount (",eY,"%):"]})]}),(0,t.jsx)("span",{children:D&&eV.cashDiscount>0?`- LKR ${eV.cashDiscount.toLocaleString()}`:`LKR ${eV.cashDiscount.toLocaleString()}`})]}),(0,t.jsxs)("div",{className:`${o.default.totalRow} ${o.default.netTotal}`,children:[(0,t.jsx)("span",{children:"Net Total:"}),(0,t.jsxs)("span",{children:["LKR ",eV.netTotal.toLocaleString()]})]}),!h.hideCostProfit&&(0,t.jsxs)("div",{className:o.default.totalRow,children:[(0,t.jsx)("span",{children:"Total Cost:"}),(0,t.jsxs)("span",{children:["LKR ",eV.totalCost.toLocaleString()]})]}),!h.hideCostProfit&&(0,t.jsxs)("div",{className:`${o.default.totalRow} ${o.default.profitRow}`,children:[(0,t.jsx)("span",{children:"Total Profit:"}),(0,t.jsxs)("span",{style:{color:eV.totalProfit>=0?"#28a745":"#dc3545",fontWeight:"bold"},children:["LKR ",eV.totalProfit.toLocaleString()]})]})]})}),(0,t.jsxs)("div",{className:o.default.submitSection,children:[(0,t.jsx)("button",{type:"submit",disabled:ep||0===L.length||eB()&&e$||eB()&&!eZ(),className:o.default.submitButton,children:ep?"Updating Invoice...":"Update Invoice"}),(0,t.jsx)("button",{type:"button",onClick:()=>ey(null),className:o.default.cancelButton,disabled:ep,children:"Cancel Edit"})]})]})]})]}):(0,t.jsx)("div",{className:o.default.unauthorized,children:"You are not authorized to access this page."})};e.s(["default",0,()=>(0,t.jsx)(i.Suspense,{fallback:(0,t.jsx)("div",{children:"Loading invoice editor..."}),children:(0,t.jsx)(d,{})})])}]);