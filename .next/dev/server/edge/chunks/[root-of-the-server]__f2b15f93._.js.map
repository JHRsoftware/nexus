{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport type { NextRequest } from 'next/server';\r\n\r\n// Define protected routes and their required permissions\r\nconst protectedRoutes = {\r\n  '/users': 'users',\r\n  '/products': 'products',\r\n  '/products/add': 'products',\r\n  '/suppliers': 'suppliers', \r\n  '/suppliers/add': 'suppliers',\r\n  '/shops': 'shops',\r\n  '/shops/add': 'shops',\r\n  '/grn': 'grn',\r\n  '/grn/add': 'grn',\r\n  '/discounts': 'discounts',\r\n  '/discounts/add': 'discounts',\r\n  '/sample1': 'sample1',\r\n  '/sample2': 'sample2',\r\n  '/reports': 'reports',\r\n  '/settings': 'settings',\r\n  '/debug-access': 'settings'\r\n};\r\n\r\n// Public routes that don't require authentication\r\nconst publicRoutes = ['/login', '/api/auth/login', '/api/auth/logout'];\r\n\r\nexport function middleware(request: NextRequest) {\r\n  const { pathname } = request.nextUrl;\r\n\r\n  // Allow public routes\r\n  if (publicRoutes.some(route => pathname.startsWith(route))) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // Allow API routes (except auth which is handled above)\r\n  if (pathname.startsWith('/api/')) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // Allow static files and Next.js internals\r\n  if (\r\n    pathname.startsWith('/_next/') ||\r\n    pathname.startsWith('/favicon.ico') ||\r\n    pathname.includes('.')\r\n  ) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // Get user data from cookies or headers\r\n  let userData = null;\r\n  \r\n  try {\r\n    // Try to get user from session storage via cookie (for client-side)\r\n    const userCookie = request.cookies.get('currentUser');\r\n    if (userCookie) {\r\n      userData = JSON.parse(userCookie.value);\r\n    }\r\n  } catch (error) {\r\n    // If cookie parsing fails, redirect to login\r\n    console.log('Invalid user cookie, redirecting to login');\r\n  }\r\n\r\n  // Check if route requires authentication\r\n  const requiredPermission = protectedRoutes[pathname as keyof typeof protectedRoutes];\r\n  \r\n  if (requiredPermission) {\r\n    // Route requires authentication\r\n    if (!userData) {\r\n      console.log(`Middleware: Redirecting to login from ${pathname} - No user data`);\r\n      return NextResponse.redirect(new URL('/login', request.url));\r\n    }\r\n\r\n    // Check if user has required permission\r\n    if (!userData.accessPages || !userData.accessPages.includes(requiredPermission)) {\r\n      console.log(`Middleware: Access denied to ${pathname} for user ${userData.username} - Missing permission: ${requiredPermission}`);\r\n      \r\n      // Find first accessible page for redirect\r\n      if (userData.accessPages && userData.accessPages.length > 0) {\r\n          const pageRoutes: Record<string, string> = {\r\n            'home': '/',\r\n            'sample1': '/sample1',\r\n            'sample2': '/sample2',\r\n            'users': '/users',\r\n            'products': '/products/add',\r\n            'suppliers': '/suppliers/add',\r\n            'shops': '/shops/add',\r\n            'grn': '/grn/add',\r\n            'discounts': '/discounts/add',\r\n            'settings': '/settings',\r\n            'reports': '/reports',\r\n            'debug': '/debug-access'\r\n          };        const firstAccessiblePage = userData.accessPages[0];\r\n        const redirectRoute = pageRoutes[firstAccessiblePage] || '/';\r\n        \r\n        console.log(`Middleware: Redirecting to accessible page: ${redirectRoute}`);\r\n        return NextResponse.redirect(new URL(redirectRoute, request.url));\r\n      } else {\r\n        // No accessible pages, redirect to login\r\n        console.log(`Middleware: No accessible pages, redirecting to login`);\r\n        return NextResponse.redirect(new URL('/login', request.url));\r\n      }\r\n    }\r\n  }\r\n\r\n  // For home page ('/'), check if user is authenticated\r\n  if (pathname === '/') {\r\n    if (!userData) {\r\n      console.log(`Middleware: Redirecting to login from home - No authentication`);\r\n      return NextResponse.redirect(new URL('/login', request.url));\r\n    }\r\n    \r\n    // Check if user has access to home page\r\n    if (!userData.accessPages || !userData.accessPages.includes('home')) {\r\n      // Redirect to first accessible page\r\n      if (userData.accessPages && userData.accessPages.length > 0) {\r\n        const pageRoutes: Record<string, string> = {\r\n          'sample1': '/sample1',\r\n          'sample2': '/sample2',\r\n          'users': '/users',\r\n          'products': '/products/add',\r\n          'suppliers': '/suppliers/add',\r\n          'shops': '/shops/add',\r\n          'grn': '/grn/add',\r\n          'discounts': '/discounts/add',\r\n          'settings': '/settings',\r\n          'reports': '/reports',\r\n          'debug': '/debug-access'\r\n        };\r\n        \r\n        const firstAccessiblePage = userData.accessPages[0];\r\n        const redirectRoute = pageRoutes[firstAccessiblePage] || '/login';\r\n        \r\n        console.log(`Middleware: Redirecting from home to accessible page: ${redirectRoute}`);\r\n        return NextResponse.redirect(new URL(redirectRoute, request.url));\r\n      } else {\r\n        return NextResponse.redirect(new URL('/login', request.url));\r\n      }\r\n    }\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\n// Configure which routes the middleware should run on\r\nexport const config = {\r\n  matcher: [\r\n    /*\r\n     * Match all request paths except for the ones starting with:\r\n     * - api/auth (auth endpoints)\r\n     * - _next/static (static files)\r\n     * - _next/image (image optimization files)\r\n     * - favicon.ico (favicon file)\r\n     * - public (public files)\r\n     */\r\n    '/((?!api/auth|_next/static|_next/image|favicon.ico|public).*)',\r\n  ],\r\n};"],"names":[],"mappings":"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"}}]
}