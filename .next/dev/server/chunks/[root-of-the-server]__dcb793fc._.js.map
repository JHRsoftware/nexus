{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///D:/New%20NextJs%20Project%20Samitha/my-nextjs-app%20-%20Postgres/src/app/api/invoices/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient() as any;\r\n\r\n// GET - Fetch single invoice with all details\r\nexport async function GET(\r\n  req: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id } = await params;\r\n    const invoiceId = parseInt(id);\r\n    \r\n    if (!invoiceId || isNaN(invoiceId)) {\r\n      return NextResponse.json({ error: 'Invalid invoice ID' }, { status: 400 });\r\n    }\r\n\r\n    // Fetch invoice with all related data\r\n    const invoice = await prisma.invoice.findUnique({\r\n      where: { id: invoiceId },\r\n      include: {\r\n        shop: {\r\n          select: {\r\n            id: true,\r\n            shopName: true,\r\n            ownerName: true,\r\n            contactNumber: true,\r\n            creditLimit: true,\r\n            balanceAmount: true\r\n          }\r\n        },\r\n        salesRep: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            contactNumber: true,\r\n            status: true\r\n          }\r\n        },\r\n        discount: {\r\n          select: {\r\n            id: true,\r\n            discountName: true,\r\n            percentage: true\r\n          }\r\n        },\r\n        invoiceItems: {\r\n          include: {\r\n            product: {\r\n              select: {\r\n                id: true,\r\n                productCode: true,\r\n                itemName: true,\r\n                sellingPrice: true,\r\n                availableQty: true\r\n              }\r\n            }\r\n          }\r\n        },\r\n        pendingPayment: {\r\n          select: {\r\n            id: true,\r\n            dueDate: true,\r\n            paymentStatus: true,\r\n            remainingAmount: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!invoice) {\r\n      return NextResponse.json({ error: 'Invoice not found' }, { status: 404 });\r\n    }\r\n\r\n    // Get cost prices for all products in the invoice using totalCost/availableQty\r\n    const productIds = invoice.invoiceItems.map((item: any) => item.product.id);\r\n    const productsWithCost = await prisma.product.findMany({\r\n      where: {\r\n        id: { in: productIds }\r\n      },\r\n      select: {\r\n        id: true,\r\n        totalCost: true,\r\n        availableQty: true\r\n      }\r\n    });\r\n\r\n    const costPriceMap = new Map();\r\n    productsWithCost.forEach((product: any) => {\r\n      const costPrice = product.availableQty > 0 \r\n        ? parseFloat((product.totalCost / product.availableQty).toFixed(2))\r\n        : 0;\r\n      costPriceMap.set(product.id, costPrice);\r\n    });\r\n\r\n    // Format invoice items for edit form\r\n    const formattedInvoiceItems = invoice.invoiceItems.map((item: any, index: number) => ({\r\n      id: `item_${index}`,\r\n      productId: item.product.id,\r\n      productCode: item.product.productCode,\r\n      productName: item.product.itemName,\r\n      quantity: item.quantity,\r\n      sellingPrice: item.sellingPrice,\r\n      discount: item.discount || 0,\r\n      price: item.price,\r\n      totalPrice: item.totalPrice,\r\n      availableQty: item.product.availableQty + item.quantity, // Add back the quantity that was used\r\n      costPrice: costPriceMap.get(item.product.id) || 0\r\n    }));\r\n\r\n    const formattedInvoice = {\r\n      ...invoice,\r\n      shop: invoice.shop,\r\n      salesRep: invoice.salesRep,\r\n      discount: invoice.discount,\r\n      invoiceItems: formattedInvoiceItems,\r\n      dueDate: invoice.pendingPayment?.dueDate || null\r\n    };\r\n\r\n    return NextResponse.json({ success: true, invoice: formattedInvoice });\r\n  } catch (error) {\r\n    console.error('Error fetching invoice details:', error);\r\n    return NextResponse.json({ error: 'Server error' }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}