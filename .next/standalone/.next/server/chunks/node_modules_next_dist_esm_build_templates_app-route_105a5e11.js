module.exports=[57736,e=>{"use strict";var t=e.i(47909),a=e.i(74017),r=e.i(96250),n=e.i(59756),i=e.i(61916),o=e.i(14444),s=e.i(37092),u=e.i(69741),l=e.i(16795),d=e.i(87718),c=e.i(95169),p=e.i(47587),v=e.i(66012),h=e.i(70101),m=e.i(26937),f=e.i(10372),I=e.i(93695);e.i(52474);var w=e.i(220),y=e.i(89171),g=e.i(84168);async function R(e){let t=e||g.prisma,a=await t.invoice.findMany({select:{invoiceNumber:!0},where:{invoiceNumber:{startsWith:"INV-"}},orderBy:{createdAt:"desc"}}),r=1;if(a.length>0){let e=a.map(e=>{let t=e.invoiceNumber.match(/^INV-(\d+)$/);return t?parseInt(t[1]):0}).filter(e=>e>0);e.length>0&&(r=Math.max(...e)+1)}return`INV-${r.toString().padStart(3,"0")}`}async function N(e,t,a=3){for(let r=1;r<=a;r++)try{let a=await R(t),r={...e,invoiceNumber:a};return await t.invoice.create({data:r})}catch(e){if("P2002"===e.code&&e.meta?.target?.includes("invoice_number")&&r<a){await new Promise(e=>setTimeout(e,100*Math.random()));continue}throw e}}async function b(e){try{let{searchParams:t}=new URL(e.url),a=parseInt(t.get("page")||"1"),r=parseInt(t.get("limit")||"10"),n=t.get("search")||"",i=n?{OR:[{invoiceNumber:{contains:n}},{shop:{shopName:{contains:n}}},{shop:{ownerName:{contains:n}}}]}:{},[o,s]=await Promise.all([g.prisma.invoice.findMany({where:i,skip:(a-1)*r,take:r,include:{shop:!0,salesRep:!0,discount:!0,invoiceItems:{include:{product:!0}}},orderBy:{createdAt:"desc"}}),g.prisma.invoice.count({where:i})]),u=Math.ceil(s/r);return y.NextResponse.json({success:!0,invoices:o,pagination:{currentPage:a,totalPages:u,totalCount:s,hasNext:a<u,hasPrev:a>1}})}catch(e){return y.NextResponse.json({success:!1,error:"Failed to fetch invoices"},{status:500})}}async function C(e){try{let{invoiceDate:t,shopId:a,salesRepId:r,discountId:n,items:i,cashDiscountEnabled:o=!1,dueDate:s,invoiceType:u,invoiceTypePercentage:l,orderNumber:d,notes:c}=await e.json();if(!t||!a||!i||!Array.isArray(i)||0===i.length)return y.NextResponse.json({success:!1,error:"Missing required fields: invoiceDate, shopId, and items"},{status:400});let p=e.headers.get("x-user-data"),v=p?JSON.parse(p):null,h=v?.name||"Unknown",m=await g.prisma.shop.findUnique({where:{id:parseInt(a)}});if(!m)return y.NextResponse.json({success:!1,error:"Shop not found"},{status:404});if(!m.isActive)return y.NextResponse.json({success:!1,error:"Cannot create invoice for inactive shop. Please contact administrator."},{status:400});let f=await g.prisma.settings.findFirst({orderBy:{id:"desc"}}),I=f?.totalBalanceDiscountPercent||5,w=null;if(n&&(!(w=await g.prisma.discount.findUnique({where:{id:parseInt(n)}}))||!w.isActive))return y.NextResponse.json({success:!1,error:"Invalid or inactive discount"},{status:400});let R=0,b=0;for(let e of i){if(!e.productId||!e.quantity||void 0===e.sellingPrice||null===e.sellingPrice)return y.NextResponse.json({success:!1,error:"Invalid item data"},{status:400});let t=await g.prisma.product.findUnique({where:{id:parseInt(e.productId)}});if(!t)return y.NextResponse.json({success:!1,error:`Product with ID ${e.productId} not found`},{status:404});let a=parseFloat(e.quantity),r=parseFloat(e.sellingPrice),n=parseFloat(e.discount||0);if(a<=0)return y.NextResponse.json({success:!1,error:`Invalid quantity for product "${t.itemName}". Quantity must be greater than 0`},{status:400});if(a>t.availableQty)return y.NextResponse.json({success:!1,error:`Cannot save invoice! Insufficient stock for product "${t.itemName}" (${t.productCode}). Available: ${t.availableQty}, Requested: ${a}. Please reduce the quantity to ${t.availableQty} or less.`},{status:400});let i=a*r-n;R+=i,b+=n}let C=l?R*(parseFloat(l)/100):0,x=o?I/100*R:0,P=R-C-x,q=[],D=[];for(let e of i){let t=await g.prisma.product.findUnique({where:{id:parseInt(e.productId)},select:{id:!0,itemName:!0,productCode:!0,availableQty:!0,totalCost:!0}});if(!t){q.push(`Product with ID ${e.productId} not found in database`);continue}let a=parseFloat(e.quantity),r=t.availableQty;D.push({...e,productData:t,requestedQuantity:a}),a>r&&q.push(`${t.itemName} (${t.productCode}): Current Available: ${r}, Requested: ${a}. Maximum allowed: ${r}`),a<=0&&q.push(`${t.itemName} (${t.productCode}): Invalid quantity ${a}. Must be greater than 0`)}if(q.length>0)return y.NextResponse.json({success:!1,error:`❌ Cannot save invoice! Stock validation failed:

${q.join("\n\n")}

⚠️ Please refresh the page and check current stock levels before trying again.`},{status:400});let $=await g.prisma.$transaction(async e=>{for(let t of D){let a=await e.product.findUnique({where:{id:parseInt(t.productId)},select:{availableQty:!0,itemName:!0,productCode:!0}});if(!a)throw Error(`Product ${t.productId} not found during transaction`);if(t.requestedQuantity>a.availableQty)throw Error(`❌ Transaction blocked! Stock changed during processing. Product: ${a.itemName} (${a.productCode}). Available: ${a.availableQty}, Requested: ${t.requestedQuantity}. Please refresh and try again.`)}let i=0,p=0;for(let e of D){let t=e.requestedQuantity,a=parseFloat(e.sellingPrice),r=parseFloat(e.discount||0),n=t*a-r,s=(e.productData.totalCost>0&&e.productData.availableQty>0?e.productData.totalCost/e.productData.availableQty:0)*t,u=l?n*(parseFloat(l)/100):0,d=o?I/100*n:0,c=n-u-d-s;i+=s,p+=c}let v=await N({invoiceDate:new Date(t),shopId:parseInt(a),salesRepId:r?parseInt(r):null,discountId:n?parseInt(n):null,orderNumber:d||null,subTotal:R,totalDiscount:b,cashDiscount:x,cashDiscountEnabled:o,cashDiscountPercentage:o?I:0,invoiceType:u||null,invoiceTypePercentage:l?parseFloat(l):null,netTotal:P,totalCost:i,totalProfit:p,notes:c||null,user:h},e);for(let t of D){let a=t.requestedQuantity,r=parseFloat(t.sellingPrice),n=parseFloat(t.discount||0),i=a*r,s=i-n,u=(t.productData.totalCost>0&&t.productData.availableQty>0?t.productData.totalCost/t.productData.availableQty:0)*a,d=l?s*(parseFloat(l)/100):0,c=o?I/100*s:0,p=s-d-c-u;await e.invoiceItem.create({data:{invoiceId:v.id,productId:parseInt(t.productId),quantity:a,sellingPrice:r,discount:n,price:i,totalPrice:s,itemCost:u,itemProfit:p}});let h=await e.product.findUnique({where:{id:parseInt(t.productId)}});if(h){let r=h.totalCost.toNumber()/(h.availableQty||1)*a,n=Math.max(0,h.availableQty-Math.floor(a)),i=Math.max(0,h.totalCost.toNumber()-r);await e.product.update({where:{id:parseInt(t.productId)},data:{availableQty:n,totalCost:i}})}}if(w&&w.discountName.toLowerCase().includes("credit")){let n;if(await e.shop.update({where:{id:parseInt(a)},data:{balanceAmount:{increment:parseFloat(P.toString())}}}),s)n=new Date(s);else{let e=new Date(t);(n=new Date(e)).setDate(n.getDate()+90)}await e.pendingPayment.create({data:{invoiceId:v.id,shopId:parseInt(a),salesRepId:r?parseInt(r):null,netTotal:parseFloat(P.toString()),paidAmount:0,remainingAmount:parseFloat(P.toString()),paymentStatus:"pending",dueDate:n,user:h}})}return d&&(await e.order.updateMany({where:{orderNumber:d,status:{not:"completed"}},data:{status:"completed"}})).count,v});return y.NextResponse.json({success:!0,message:"Invoice created successfully",invoice:$})}catch(e){return y.NextResponse.json({success:!1,error:"Failed to create invoice"},{status:500})}}async function x(e){try{let{id:t,invoiceDate:a,shopId:r,salesRepId:n,discountId:i,items:o,cashDiscountEnabled:s=!1,invoiceType:u,invoiceTypePercentage:l,notes:d}=await e.json();if(!t)return y.NextResponse.json({success:!1,error:"Invoice ID is required"},{status:400});let c=e.headers.get("x-user-data"),p=c?JSON.parse(c):null,v=p?.name||"Unknown",h=await g.prisma.invoice.findUnique({where:{id:parseInt(t)},include:{invoiceItems:!0,discount:!0,shop:!0}});if(!h)return y.NextResponse.json({success:!1,error:"Invoice not found"},{status:404});let m=await g.prisma.settings.findFirst({orderBy:{id:"desc"}}),f=m?.totalBalanceDiscountPercent||5,I=null;if(i&&(!(I=await g.prisma.discount.findUnique({where:{id:parseInt(i)}}))||!I.isActive))return y.NextResponse.json({success:!1,error:"Invalid or inactive discount"},{status:400});let w=h.discount&&h.discount.discountName.toLowerCase().includes("credit"),R=I&&I.discountName.toLowerCase().includes("credit"),N=Number(h.netTotal),b=0,C=0;for(let e of o){if(!e.productId||!e.quantity||void 0===e.sellingPrice||null===e.sellingPrice)return y.NextResponse.json({success:!1,error:"Invalid item data"},{status:400});let t=await g.prisma.product.findUnique({where:{id:parseInt(e.productId)}});if(!t)return y.NextResponse.json({success:!1,error:`Product with ID ${e.productId} not found`},{status:404});let a=parseFloat(e.quantity),r=parseFloat(e.sellingPrice),n=parseFloat(e.discount||0),i=h.invoiceItems.find(t=>t.productId===parseInt(e.productId)),o=i?Number(i.quantity):0,s=t.availableQty+o;if(a<=0)return y.NextResponse.json({success:!1,error:`Invalid quantity for product "${t.itemName}". Quantity must be greater than 0`},{status:400});if(a>s)return y.NextResponse.json({success:!1,error:`Cannot update invoice! Insufficient stock for product "${t.itemName}" (${t.productCode}). Available (including current allocation): ${s}, Requested: ${a}. Please reduce the quantity to ${s} or less.`},{status:400});let u=a*r-n;b+=u,C+=n}let x=l?b*(parseFloat(l)/100):0,P=s?f/100*b:0,q=b-x-P,D=0,$=0,A=[],E=[];for(let e of o){let t=await g.prisma.product.findUnique({where:{id:parseInt(e.productId)},select:{id:!0,itemName:!0,productCode:!0,availableQty:!0,totalCost:!0}});if(!t){A.push(`Product with ID ${e.productId} not found`);continue}let a=parseFloat(e.quantity),r=h.invoiceItems.find(t=>t.productId===parseInt(e.productId)),n=r?Number(r.quantity):0,i=t.availableQty+n;E.push({...e,productData:t,requestedQuantity:a,currentlyAllocated:n,availableAfterReturn:i}),a>i&&A.push(`${t.itemName} (${t.productCode}): Available (including current): ${i}, Requested: ${a}`),a<=0&&A.push(`${t.itemName} (${t.productCode}): Invalid quantity ${a}`)}if(A.length>0)return y.NextResponse.json({success:!1,error:`❌ Cannot update invoice! Stock validation failed:

${A.join("\n\n")}

⚠️ Please refresh and check current stock levels.`},{status:400});for(let e of E){let t=e.requestedQuantity,a=parseFloat(e.sellingPrice),r=parseFloat(e.discount||0),n=t*a-r,i=(e.productData.totalCost>0&&e.productData.availableQty>0?e.productData.totalCost/e.productData.availableQty:0)*t,o=l?n*(parseFloat(l)/100):0,u=s?f/100*n:0,d=n-o-u-i;D+=i,$+=d}let F=await g.prisma.$transaction(async e=>{for(let a of(await e.invoiceItem.findMany({where:{invoiceId:parseInt(t)},include:{product:!0}})))if(a.product){let t=a.product.totalCost.toNumber()/(a.product.availableQty||1)*Number(a.quantity);await e.product.update({where:{id:a.productId},data:{availableQty:{increment:Math.floor(Number(a.quantity))},totalCost:{increment:t}}})}await e.invoiceItem.deleteMany({where:{invoiceId:parseInt(t)}});let o=await e.invoice.update({where:{id:parseInt(t)},data:{invoiceDate:new Date(a),shopId:parseInt(r),salesRepId:n?parseInt(n):null,discountId:i?parseInt(i):null,subTotal:b,totalDiscount:C,cashDiscount:P,cashDiscountEnabled:s,cashDiscountPercentage:s?f:0,invoiceType:u||null,invoiceTypePercentage:l?parseFloat(l):null,netTotal:q,totalCost:D,totalProfit:$,notes:d||null,user:v}});for(let t of E){let a=t.requestedQuantity,r=parseFloat(t.sellingPrice),n=parseFloat(t.discount||0),i=a*r,u=i-n,d=(t.productData.totalCost>0&&t.productData.availableQty>0?t.productData.totalCost/t.productData.availableQty:0)*a,c=l?u*(parseFloat(l)/100):0,p=s?f/100*u:0,v=u-c-p-d;await e.invoiceItem.create({data:{invoiceId:o.id,productId:parseInt(t.productId),quantity:a,sellingPrice:r,discount:n,price:i,totalPrice:u,itemCost:d,itemProfit:v}});let h=await e.product.findUnique({where:{id:parseInt(t.productId)},select:{id:!0,itemName:!0,productCode:!0,availableQty:!0}});if(!h)throw Error(`Product ${t.productId} not found in final transaction validation`);if(a>h.availableQty)throw Error(`Final transaction validation failed for ${h.itemName} (${h.productCode}): Available: ${h.availableQty}, Requested: ${a}. Stock was modified by another process.`);let m=await e.product.findUnique({where:{id:parseInt(t.productId)}});if(m){let r=m.totalCost.toNumber()/(m.availableQty||1)*a,n=Math.max(0,m.availableQty-Math.floor(a)),i=Math.max(0,m.totalCost.toNumber()-r);await e.product.update({where:{id:parseInt(t.productId)},data:{availableQty:n,totalCost:i}})}}let c=0;if(c=w&&R?q-N:w&&!R?-N:!w&&R?q:0,0!==c&&await e.shop.update({where:{id:parseInt(r)},data:{balanceAmount:{increment:parseFloat(c.toString())}}}),w||R){let i=await e.pendingPayment.findUnique({where:{invoiceId:parseInt(t)}});if(w&&!R)i&&await e.pendingPayment.delete({where:{invoiceId:parseInt(t)}});else if(!w&&R){let i=new Date(a),o=new Date(i);o.setDate(o.getDate()+90),await e.pendingPayment.create({data:{invoiceId:parseInt(t),shopId:parseInt(r),salesRepId:n?parseInt(n):null,netTotal:parseFloat(q.toString()),paidAmount:0,remainingAmount:parseFloat(q.toString()),paymentStatus:"pending",dueDate:o,user:v}})}else if(w&&R&&i){let a=q-Number(i.paidAmount),r="pending";a<=0?r="completed":Number(i.paidAmount)>0&&(r="partial"),await e.pendingPayment.update({where:{invoiceId:parseInt(t)},data:{netTotal:parseFloat(q.toString()),remainingAmount:parseFloat(a.toString()),paymentStatus:r}})}}return o});return y.NextResponse.json({success:!0,message:"Invoice updated successfully",invoice:F})}catch(e){return y.NextResponse.json({success:!1,error:"Failed to update invoice"},{status:500})}}async function P(e){try{let{searchParams:t}=new URL(e.url),a=t.get("id");if(!a)return y.NextResponse.json({success:!1,error:"Invoice ID is required"},{status:400});let r=await g.prisma.invoice.findUnique({where:{id:parseInt(a)},include:{shop:!0}});if(!r)return y.NextResponse.json({success:!1,error:"Invoice not found"},{status:404});return await g.prisma.invoice.delete({where:{id:parseInt(a)}}),y.NextResponse.json({success:!0,message:`Invoice ${r.invoiceNumber} deleted successfully`})}catch(e){return y.NextResponse.json({success:!1,error:"Failed to delete invoice"},{status:500})}}e.s(["DELETE",()=>P,"GET",()=>b,"POST",()=>C,"PUT",()=>x],23804);var q=e.i(23804);let D=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/invoices/route",pathname:"/api/invoices",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/invoices/route.ts",nextConfigOutput:"standalone",userland:q}),{workAsyncStorage:$,workUnitAsyncStorage:A,serverHooks:E}=D;function F(){return(0,r.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:A})}async function S(e,t,r){D.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/invoices/route";y=y.replace(/\/index$/,"")||"/";let g=await D.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!g)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:N,nextConfig:b,parsedUrl:C,isDraftMode:x,prerenderManifest:P,routerServerContext:q,isOnDemandRevalidate:$,revalidateOnlyGenerated:A,resolvedPathname:E,clientReferenceManifest:F,serverActionsManifest:S}=g,j=(0,u.normalizeAppPath)(y),Q=!!(P.dynamicRoutes[j]||P.routes[E]),T=async()=>((null==q?void 0:q.render404)?await q.render404(e,t,C,!1):t.end("This page could not be found"),null);if(Q&&!x){let e=!!P.routes[E],t=P.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await T();throw new I.NoFallbackError}}let U=null;!Q||D.isDev||x||(U="/index"===(U=E)?"/":U);let M=!0===D.isDev||!Q,k=Q&&!M;S&&F&&(0,o.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:F,serverActionsManifest:S,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:S})});let O=e.method||"GET",_=(0,i.getTracer)(),H=_.getActiveScopeSpan(),B={params:N,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>D.onRequestError(e,t,r,q)},sharedContext:{buildId:R}},L=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let o=async e=>D.handle(V,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=_.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${O} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${O} ${y}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),u=async n=>{var i,u;let l=async({previousCacheEntry:a})=>{try{if(!s&&$&&A&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let u=B.renderOpts.pendingWaitUntil;u&&r.waitUntil&&(r.waitUntil(u),u=void 0);let l=B.renderOpts.collectedTags;if(!Q)return await (0,v.sendResponse)(L,K,i,B.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[f.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:$})},q),t}},d=await D.handleResponse({req:e,nextConfig:b,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:$,revalidateOnlyGenerated:A,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:s});if(!Q)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",$?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&Q||c.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,v.sendResponse)(L,K,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};H?await u(H):await _.withPropagatedContext(e.headers,()=>_.trace(c.BaseServerSpan.handleRequest,{spanName:`${O} ${y}`,kind:i.SpanKind.SERVER,attributes:{"http.method":O,"http.target":e.url}},u))}catch(t){if(t instanceof I.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:$})}),Q)throw t;return await (0,v.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>F,"routeModule",()=>D,"serverHooks",()=>E,"workAsyncStorage",()=>$,"workUnitAsyncStorage",()=>A],57736)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_105a5e11.js.map